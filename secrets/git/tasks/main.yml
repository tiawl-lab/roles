---

- block:
  - module_defaults:
      ansible.builtin.command:
        chdir: "{{ secrets_cwd + '/' + repo_main_passwordstore_submodule_path }}"
    block:
    - name: Run the git command into the password-store repository
      ansible.builtin.command: "{{ passwordstore_git_cmd + ' ' + secrets_git_cmdargs }}"
    - name: Commit the given message into the password-store repository
      ansible.builtin.command: "{{ passwordstore_git_cmd + ' commit -m ' + (secrets_git_commitmsg | quote) }}"
      # It commits if it knows that it pushes after
      when: secrets_git_push and (secrets_git_commitmsg | length > 0)
    - name: Push the password-store if needed
      ansible.builtin.command: "{{ passwordstore_git_cmd + ' push' }}"
      # It can push without comitting
      when: secrets_git_push
    environment:
      PASSWORD_STORE_DIR: "{{ secrets_cwd + '/' + repo_main_passwordstore_submodule_path }}"
  - module_defaults:
      ansible.builtin.command:
        chdir: "{{ secrets_cwd }}"
    when: secrets_git_push
    block:
    - name: Stage the updated password-store submodule of the main repository
      ansible.builtin.command: git add -A
    - name: Commit the updated password-store submodule of the main repository
      ansible.builtin.command: git commit -m 'Update the password-store submodule'
    - name: Push the main repository with the updated password-store submodule
      ansible.builtin.command: git push
  rescue:
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tests/secrets/pre/cleanup.yml"
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tasks/secrets/cleanup.yml"
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tests/secrets/post/cleanup.yml"
    - ansible.builtin.fail:
        msg: "A previous rescued task failed"
